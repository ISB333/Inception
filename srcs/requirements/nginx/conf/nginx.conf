# Nginx main configuration
# - Runs nginx worker processes under www-data user
# - Automatically detects number of CPU cores for worker processes
# - Stores process ID in /run/nginx.pid
# - Loads all enabled nginx modules from /etc/nginx/modules-enabled/
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

# Configures Nginx event processing
# Sets the maximum number of simultaneous connections per worker process to 768
events {
	worker_connections 768;
}

http {
	## ========================================
	# Basic Settings
	## ========================================

	# Core performance and functionality settings for Nginx server
	# - sendfile: Enable efficient file transmission using kernel sendfile
	# - tcp_nopush: Optimize packet transmission by waiting for full packets
	# - tcp_nodelay: Disable Nagle's algorithm for immediate data transmission
	# - keepalive_timeout: Connection idle timeout in seconds (65s)
	# - types_hash_max_size: Maximum hash table size for MIME types (2048 bytes)
	# - include: Load MIME type definitions
	# - default_type: Default content type for responses without explicit type
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	types_hash_max_size 2048;
	include /etc/nginx/mime.types;
	default_type application/octet-stream;


	## ========================================
	# Logging Settings
	## ========================================
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	# NGINX SSL Server Configuration for WordPress
	# Configures a secure HTTPS server for WordPress with TLS 1.2/1.3
	# - Listens on port 443 with SSL/TLS encryption
	# - Serves WordPress from /var/www/wordpress
	# - Routes requests to PHP-FPM container (wp-php:9000)
	# - Uses modern cipher suites for enhanced security
	# - Implements URL rewriting for WordPress permalinks
	# - Blocks access to .htaccess files
	# - Requires SSL certificate and key at specified paths
	server {
		listen 443 ssl;
		server_name adesille.42.fr;
		
		ssl_protocols TLSv1.2 TLSv1.3;
		ssl_prefer_server_ciphers on;
		ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
		ssl_certificate /etc/ssl/certs/inception.crt;
		ssl_certificate_key /etc/ssl/private/inception.key;
		
		root /var/www/wordpress;
		index index.php index.html index.htm;
		
		# Routes all requests to index.php if the requested file or directory doesn't exist.
		# This enables client-side routing for single-page applications.
		location / {
			try_files $uri $uri/ /index.php?$args;
		}
		
		# Handles PHP file requests by passing them to the PHP-FPM service
		# Splits the path into script and path info components
		# Forwards requests to wp-php container on port 9000
		# Includes standard FastCGI parameters and sets script filename and path info
		location ~ \.php$ {
			fastcgi_split_path_info ^(.+\.php)(/.+)$;
			fastcgi_pass wp-php:9000;
			fastcgi_index index.php;
			include fastcgi_params;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;
		}
		
		# Blocks access to hidden configuration files like .htaccess and .htpasswd
		# These files often contain sensitive server settings and authentication info
		# Using regex pattern (~) to match any file starting with .ht
		location ~ /\.ht {
			deny all;
		}
	}
}